name: depup

on:
  schedule:
    - cron: '14 14 * * *'
  workflow_dispatch:

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      files: ${{ steps.set-matrix.outputs.files }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Gather all README.adoc paths
        id: set-matrix
        run: |
          echo "::group::Scanning for README.adoc…"
          files=$(find data-transforms -type f -name 'README.adoc' \
            | jq -R -s -c 'split("\n")[:-1]')
          echo "files=$files" >> "$GITHUB_OUTPUT"
          echo "::endgroup::"

  reviewdog:
    needs: generate-matrix
    runs-on: ubuntu-latest
    concurrency:
      group: depup-${{ matrix.repo }}-${{ matrix.file }}
      cancel-in-progress: true
    strategy:
      matrix:
        repo:
          - redpanda-data/redpanda
          - redpanda-data/console
        file: ${{ fromJson(needs.generate-matrix.outputs.files) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run reviewdog depup
        id: depup
        uses: reviewdog/action-depup@v1
        with:
          repo: ${{ matrix.repo }}
          file: ${{ matrix.file }}
          # pick the right version_name per repo
          version_name: ${{ matrix.repo == 'redpanda-data/redpanda' && 'latest-redpanda-version' || 'latest-console-version' }}

      - name: Sanitize & trim branch name
        id: sanitize
        run: |
          sanitized=$(echo "${{ matrix.file }}" \
            | tr '/.' '-' \
            | sed 's/[^A-Za-z0-9_-]//g' \
            | cut -c 1-50)
          echo "branch_name=depup-${sanitized}" >> "$GITHUB_ENV"

      - name: Create pull request
        if: steps.depup.outputs.updated == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.branch_name }}
          title: |
            chore(deps): update ${{ matrix.repo }} → ${{ steps.depup.outputs.latest }}
          commit-message: |
            chore(deps): update ${{ matrix.repo }} → ${{ steps.depup.outputs.latest }}
          body: |
            This bumps **${{ matrix.repo }}**
            from ${{ steps.depup.outputs.current }} → ${{ steps.depup.outputs.latest }}.

            Auto-generated by the depup workflow.
          reviewers: JakeSCahill
