// CI Test for Envoy Proxy Failover
// Uses lightweight single-broker clusters for faster CI runs

// (test start {"id":"envoy-proxy-failover-ci", "description": "CI test for Envoy proxy failover"})
// (step {"action":"runShell", "command": "docker compose -f docker-compose.ci.yml down -v 2>/dev/null || true", "workingDirectory": "../docker-compose/envoy-proxy"})

// (step {"action":"runShell", "command": "docker compose -f docker-compose.ci.yml up -d --wait", "workingDirectory": "../docker-compose/envoy-proxy", "timeout": 300000})
// (step {"action":"wait", "duration": 5000})

// Verify brokers are healthy
// (step {"action":"runShell", "command": "docker exec primary-broker-0 rpk cluster health", "output": "/Healthy/"})

// Create topic on both clusters
// (step {"action":"runShell", "command": "docker exec primary-broker-0 rpk topic create failover-demo-topic -r 1", "output": "/failover-demo-topic/"})
// (step {"action":"runShell", "command": "docker exec secondary-broker-0 rpk topic create failover-demo-topic -r 1"})

// Verify Envoy sees 2 healthy endpoints (1 per cluster)
// (step {"action":"runShell", "command": "curl -s localhost:9901/clusters | grep -c healthy", "output": "/2/"})

// Test producing through Envoy
// (step {"action":"runShell", "command": "docker exec python-client python3 /app/test-producer.py", "output": "/OK/"})

// Stop primary broker to trigger failover
// (step {"action":"runShell", "command": "docker stop primary-broker-0"})
// (step {"action":"wait", "duration": 15000})

// Test producing during failover (routes to secondary)
// (step {"action":"runShell", "command": "docker exec python-client python3 /app/test-failover-producer.py", "output": "/OK/"})

// Restart primary broker
// (step {"action":"runShell", "command": "docker start primary-broker-0"})
// (step {"action":"wait", "duration": 30000})

// Verify primary is healthy again
// (step {"action":"runShell", "command": "docker exec primary-broker-0 rpk cluster health", "output": "/Healthy/"})

// Clean up
// (step {"action":"runShell", "command": "docker compose -f docker-compose.ci.yml down -v", "workingDirectory": "../docker-compose/envoy-proxy"})

// (test end)
