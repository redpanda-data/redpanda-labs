= Transparent Failover with Envoy Proxy
:env-docker: true
:page-categories: High Availability, Integration, Networking
:description: Demonstrate transparent failover between Redpanda clusters using Envoy proxy without requiring client configuration changes or restarts.
:page-layout: lab
:page-topic-type: lab
// Learning objectives
:learning-objective-1: Deploy two independent Redpanda clusters with Envoy proxy
:learning-objective-2: Configure Envoy for priority-based routing with health checks
:learning-objective-3: Test automatic failover and failback between clusters

// (test start {"id":"envoy-proxy-failover", "description": "Transparent failover with Envoy proxy"})
// (step {"action":"runShell", "command": "docker compose down -v 2>/dev/null || true", "workingDirectory": "../docker-compose/envoy-proxy"})

This lab demonstrates how Envoy proxy can facilitate transparent failover between Redpanda clusters for clients, without requiring client configuration changes or restarts.

https://www.envoyproxy.io/[Envoy^] is a high-performance proxy that can provide load balancing, health checking, and automatic failover for TCP/HTTP traffic.

In this lab, you will:

* {learning-objective-1}
* {learning-objective-2}
* {learning-objective-3}

== Architecture

Clients connect to a single Envoy endpoint (`envoy:9092`). Envoy uses HTTP health checks against Schema Registry to monitor broker availability and detect recovery mode. When the primary cluster becomes unhealthy, Envoy automatically routes traffic to the secondary cluster using priority-based routing. When the primary recovers, traffic fails back automatically.

== Prerequisites

* https://docs.docker.com/compose/install/[Docker and Docker Compose^]
* https://github.com/mikefarah/yq[yq^] YAML processor: `brew install yq` (macOS) or `snap install yq` (Linux)
* (Linux only) `sudo` access to set file permissions: `sudo chown -R 101:101 redpanda-config/`

== Run the lab

. Clone this repository:
+
[,bash]
----
git clone https://github.com/redpanda-data/redpanda-labs.git
cd redpanda-labs/docker-compose/envoy-proxy
----

. Start the demo environment:
+
[,bash]
----
docker compose up -d --wait
----
// (step {"action":"runShell", "command": "docker compose up -d --wait", "workingDirectory": "../docker-compose/envoy-proxy", "timeout": 600000})
// (step {"action":"wait", "duration": 10000})

. Verify all brokers are healthy:
+
[,bash]
----
docker exec primary-broker-0 rpk cluster health
----
// (step {"action":"runShell", "command": "docker exec primary-broker-0 rpk cluster health", "output": "/Healthy/"})

. Create topics on both clusters:
+
[,bash]
----
./setup-topics.sh
----
// (step {"action":"runShell", "command": "./setup-topics.sh", "output": "/failover-demo-topic/", "workingDirectory": "../docker-compose/envoy-proxy"})

. Verify Envoy sees all brokers as healthy:
+
[,bash]
----
curl -s localhost:9901/clusters | grep health_flags
----
// (step {"action":"runShell", "command": "curl -s localhost:9901/clusters | grep -c healthy", "output": "/6/"})

. Test producing messages through Envoy:
+
[,bash]
----
docker exec python-client python3 /app/test-producer.py
----
// (step {"action":"runShell", "command": "docker exec python-client python3 /app/test-producer.py", "output": "/OK/"})

. Stop two brokers in the primary cluster to trigger failover:
+
[,bash]
----
docker stop primary-broker-0 primary-broker-1
----
+
Failover takes 10-15 seconds. Envoy runs health checks every 3 seconds and requires 3 consecutive failures before marking a broker as unhealthy.
// (step {"action":"runShell", "command": "docker stop primary-broker-0 primary-broker-1"})
// (step {"action":"wait", "duration": 20000})

. Test producing messages during failover (now routes to secondary):
+
[,bash]
----
docker exec python-client python3 /app/test-failover-producer.py
----
// (step {"action":"runShell", "command": "docker exec python-client python3 /app/test-failover-producer.py", "output": "/OK/"})

. Restart the primary brokers:
+
[,bash]
----
docker start primary-broker-0 primary-broker-1
----
+
Failback takes 30-40 seconds. The brokers need time to start up, elect partition leaders, and pass Envoy's health checks (2 consecutive successes required).
// (step {"action":"runShell", "command": "docker start primary-broker-0 primary-broker-1"})
// (step {"action":"wait", "duration": 40000})

. Verify traffic fails back to primary:
+
[,bash]
----
docker exec primary-broker-0 rpk cluster health
----
// (step {"action":"runShell", "command": "docker exec primary-broker-0 rpk cluster health", "output": "/Healthy/"})

NOTE: This lab uses Python `kafka-python` because Envoy's Kafka broker filter has limited protocol version support. See the https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/network_filters/kafka_broker_filter[Envoy Kafka Broker Filter documentation^] for details.

== Clean up

Tear down the demo environment:

[,bash]
----
docker compose down -v
----
// (step {"action":"runShell", "command": "docker compose down -v", "workingDirectory": "../docker-compose/envoy-proxy"})

// (test end)

== What you explored

In this lab, you:

* Deployed two independent 3-node Redpanda clusters with Envoy proxy
* Configured Envoy's Kafka broker filter for transparent TCP proxying with priority-based routing
* Tested automatic failover when the primary cluster became unhealthy
* Verified automatic failback when the primary cluster recovered

== Next steps

ifdef::env-site[]
For production disaster recovery with data replication, see the xref:redpanda-labs:docker-compose:envoy-shadowing.adoc[Envoy + Shadowing lab]. Shadowing handles offset-preserving replication while Envoy provides transparent client routing without requiring client reconfiguration during failover.
endif::[]
ifndef::env-site[]
For production disaster recovery with data replication, see the link:../envoy-shadowing/README.adoc[Envoy + Shadowing lab]. Shadowing handles offset-preserving replication while Envoy provides transparent client routing without requiring client reconfiguration during failover.
endif::[]

== Suggested reading

* https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/network_filters/kafka_broker_filter[Envoy Kafka Broker Filter^]
ifndef::env-site[]
* https://docs.redpanda.com/current/manage/disaster-recovery/[Shadowing for Disaster Recovery^]
* https://docs.redpanda.com/current/manage/recovery-mode/[Redpanda Recovery Mode^]
endif::[]
ifdef::env-site[]
* xref:ROOT:manage:disaster-recovery.adoc[]
* xref:ROOT:manage:recovery-mode.adoc[]
endif::[]
